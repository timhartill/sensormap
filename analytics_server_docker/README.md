# Analytics Server Docker

## Introduction

This reference application can be deployed on edge servers or in the cloud. 
Developers can leverage this and adapt to their specific use cases. Docker containers have been provided to further simplify deployment, adaptability, and manageability.

The architecture of the application looks approximately as follows:

![Architecture](readme-images/architecture_sensormap.png?raw=true "Architecture")

**Note**: This application creates docker containers only for Analytics Server.

The application can be run in two modes:
+ **Playback**: This mode is used to playback events from a point in time (not implemented in this version)
+ **Live**: This mode is used for seeing the events, scene as and when they are detected

## Getting Started

### Dependencies

The application requires recent versions of [Docker](https://docs.docker.com/install/linux/docker-ce/ubuntu/) and [Docker Compose](https://docs.docker.com/compose/install/#install-compose) to be installed in the machine.

### Environment Variables

Export the following Environment variables:
+ **IP_ADDRESS** - IP address of host machine
+ **GOOGLE_MAP_API_KEY** - Api Key for Google Map

Follow the instructions in this [link](https://developers.google.com/maps/documentation/javascript/get-api-key) to get an api key for Google Maps.

### Configurations

Live is the default mode of the application.

If live mode has to be used, then:
    
1. Go to `node-apis/config/config.json` and check the following is configured:

        garage.isLive: true

2. Send the data generated by the source object detection or IoT application to the kafka topic `metromind-raw`. We have provided a 'player' module as a convenient way of playing a recorded json stream (see sm-schema-v2.json and sm-template-v2.json) for details on the expcted format. Note the the application is generally tolerance of many of the json keys being omitted. Mandatory elements are @timestamp, messageid, object, sensor and event. Within object, the 'vehicle' and 'polygon' keys and several others may be omitted. 

### Installation

1. Install Docker and Docker Compose.

2. Change Configurations. In particular:

    1. To your bash config file add code to set the IP_ADDRESS and GOOGLE_MAP_API_KEYs env variables. If intending to use the UI or API modules outside of docker you must also set REACT_APP_BACKEND_IP_ADDRESS, REACT_APP_BACKEND_PORT, REACT_APP_GOOGLE_MAP_API_KEY and NODE_PORT env variables appropriately as specified in their respective readme pages.
    2. Config files are found in /config subdirectories under each module directory. Update directory paths and where necessary filenames in each module's configuration files - both those read as a part of docker container startup and, if modifying the application, those config directories in the respective source code directories.
    3. Edit 'start.sh' to set the name of your network adapter to enable automatic ip address detection (if desired, you can also reuse this code in your bash config file to set IP_ADDRESS automatically on startup). 

3. Starting Docker Containers

    The docker containers can be started either by running automation script or by starting them manually.

    **Automation Script**

    1. Ensure `start.sh` has been edited as per above configuration changes
    
    2. Run `start.sh` by executing the following command
    
            ./start.sh
    
    3. Execute the following command to stop the containers
    
            sudo docker-compose down
    
    **Note**:
    + `sudo docker-compose down` should be used to stop the containers. The execution of this command significantly reduces the time taken by docker containers to start again when `start.sh` is executed.
    + `stop.sh` should be only used when the containers need to be stopped and the docker images have to be removed from the system. `stop.sh` can be run using the following command
    
            ./stop.sh
    
    **Steps to start the containers manually**
        
    1. Export the environment variables

        a) IP Address of Host machine
        
            export IP_ADDRESS=xxx.xxx.xx.xx

        b) Google Map API Key:
    
            export GOOGLE_MAP_API_KEY=<YOUR GOOGLE_API_KEY>
    
    2. Use the following command to change the current directory.

            cd ./analytics_server_docker
         
    3. Run the docker containers using the following `docker-compose` command
    
            sudo -E docker-compose up -d

       this will start the following containers

            cassandra
            kafka
            zookeeper
            elasticsearch
            kibana
            logstash
            api
            ui
            processor
            tracker

    
        **Note**:
        + The application providing the source json info (player by default) should be started only after the analytics server is up and running.
        + Remember to shut down the docker containers of the analytics server once the player is shut down.


5.  **Generate Data** (Optional) , for test purpose ONLY, normally the SensorMap application will read from cameras and send metadata to Analytics Server. Run the following commands:
    1. cd /sensormap/player/usecasecode/player

    2. Download json file from https://drive.google.com/file/d/1YYoDzcDVQOd0cSrr6mGk5N16mfet9R99/view?usp=sharing and put into the /json_playback subdirectory

    3. Update /config/config_player_stream.json:
                "inputFileConfig": {"inputDir":"/your/directory/gitrepos/sensormap/player/json_playback",
                                    "inputFile":"your downloaded json file.json"}

    4. python stream_player.py --sconfig=`<path to stream config file>` --config=`<path to processor config file>`

        **Note**: 
        + It takes around 2 minutes for the player to load the file and get the streaming displaying in the UI.



6. **Create Elasticsearch start-Index** (Optional)

    browse to Kibana URL http://IP_ADDRESS:5601

     ![Start Index](readme-images/index-creation-1.png?raw=true "Start Index")


7. **Create Elasticsearch anomaly-Index** (Optional)

    ![Anomaly Index](readme-images/index-creation-2.png?raw=true "Anomaly Index")


8. **Test**
    
    http://IP_ADDRESS
    
    ![UI](readme-images/sensormap_full.png?raw=true "UI")    

    **Note**: The number of events that show up in the UI are fewer then in reality. This is because if a object has a lot of events within the refresh interval then the events of other objects may get obscured. To avoid this situation we display only a few events per object.
    
### References

This analytics server has multiple components like Kafka, Elasticsearch, Nodejs etc. Use the following links to get started with these components.

1. [Cassandra](http://cassandra.apache.org/doc/latest/getting_started/)
2. [Kafka](https://kafka.apache.org/intro)
3. [Zookeeper](https://zookeeper.apache.org/)
5. [Elasticsearch](https://www.elastic.co/guide/en/elasticsearch/reference/6.4/getting-started.html)
6. [Kibana](https://www.elastic.co/guide/en/kibana/6.4/getting-started.html)
7. [Logstash](https://www.elastic.co/guide/en/logstash/6.4/getting-started-with-logstash.html)
8. [Node.js](https://nodejs.org/en/docs/guides/getting-started-guide/)
9. [React](https://reactjs.org/docs/getting-started.html)
10. [Python](https://docs.python.org/3/tutorial/)
